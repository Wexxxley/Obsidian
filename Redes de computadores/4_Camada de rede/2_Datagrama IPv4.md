
---

 Um pacote de camada de rede é denominado um **datagrama**. Os principais campos do datagrama ipv4 são os seguintes: 
 - **Número da versão:** Quatro bits especificam a versão do protocolo IP do datagrama. 
 - **Comprimento do cabeçalho:** Como um datagrama IPv4 pode conter um número variável de opções, esses quatro bits são necessários para determinar onde, no datagrama IP, os dados começam de fato. A maior parte dos datagramas não contém opções; o datagrama IP típico tem um cabeçalho de **20 bytes.** 
 - **Tipo de serviço:** Usados para poder diferenciar os diferentes tipos de datagramas IP (que requerem baixo atraso, alta vazão ou confiabilidade) que devem ser distinguidos uns dos outros.
 - **Comprimento do datagrama.** É o comprimento total do datagrama IP (cabeçalho mais dados).
 - **Identificador, flags, deslocamento de fragmentação:** Esses três campos têm a ver com a fragmentação.
 - **Tempo de vida:** O campo de tempo de vida é incluído para garantir que datagramas não fiquem circulando para sempre.  Esse campo é decrementado e, uma unidade cada vez que o datagrama é processado por um roteador, ou seja, virou um ==número máximo de saltos.==
![[Pasted image 20250523103049.png]]
- **Protocolo:** Usado  quando o datagrama chega a seu destino. O valor do campo indica o protocolo de camada de transporte.
- **Soma de verificação do cabeçalho:** A soma de verificação do cabeçalho auxilia um roteador na detecção de erros de bits em um datagrama IP recebido. É calculada tratando cada 2 bytes do cabeçalho como se fossem um número e somando esses números usando complementos aritméticos de 1. Como discutimos na Seção 3.3, o complemento de 1 dessa soma, conhecida como soma de verificação da Internet, é armazenado no campo de soma de verificação. Um roteador calculará o valor da soma de verificação para cada datagrama IP recebido e detectará uma condição de erro se o valor carregado no cabeçalho do datagrama não for igual à soma de verificação calculada. Roteadores em geral descartam datagramas quando um erro é detectado. Figura 4.13 Formato do datagrama IPv4 Versão Tipo de serviço Comprimento do cabeçalho Protocolo da camada superior Identificador de 16 bits Tempo de vida Deslocamento de fragmentação (13 bits) Flags Comprimento do datagrama (bytes) Soma de verificação do cabeçalho 32 bits Endereço IP da origem Endereço IP do destino Opções (se houver) Dados A CAMADA de REDE  247 Note que a soma de verificação deve ser recalculada e armazenada de novo em cada roteador, pois o campo TTL e, possivelmente, também os campos de opções podem mudar. Uma discussão interessante sobre algoritmos rápidos para calcular a soma de verificação da Internet é encontrada em [RFC 1071]. Uma pergunta que sempre é feita nesse ponto é: por que o TCP/IP faz verificação de erro nas camadas de transporte e de rede? Há várias razões para essa repetição. Primeiro, note que, na camada IP, a soma de verificação é calculada só para o cabeçalho IP, enquanto no TCP/UDP a soma de verificação é calculada para todo o segmento TCP/IP. Segundo, o TCP/UDP e o IP não precisam necessariamente pertencer à mesma pilha de protocolos. O TCP pode, em princípio, rodar sobre um protocolo diferente (por exemplo, ATM) e o IP pode carregar dados que não serão passados ao TCP/UDP. • Endereços IP de origem e de destino. Quando uma origem cria um datagrama, insere seu endereço IP no campo de endereço de origem IP e insere o endereço do destino final no campo de endereço de destinatário IP. Muitas vezes o hospedeiro da origem determina o endereço do destinatário por meio de uma consulta ao DNS, como discutimos no Capítulo 2. Discutiremos endereçamento IP detalhadamente na Seção 4.4.2. • Opções. O campo de opções permite que um cabeçalho IP seja estendido. A intenção é que as opções de cabeçalho sejam usadas raramente — daí a decisão de poupar sobrecarga não incluindo a informação em campos de opções em todos os cabeçalhos de datagrama. Contudo, a mera existência de opções, na realidade, complica as coisas — uma vez que cabeçalhos de datagramas podem ter comprimentos variáveis, não é possível determinar a priori onde começará o campo de dados. Além disso, como alguns datagramas podem requerer processamento de opções e outros não, o tempo necessário para processar um datagrama IP em um roteador pode variar bastante. Essas considerações se tornam particularmente importantes para o processamento do IP em roteadores e hospedeiros de alto desempenho. Por essas e outras razões, as opções IP foram descartadas no cabeçalho da versão IPv6, como discutimos na Seção 4.4.4. • Dados (carga útil). Por fim, chegamos ao último e mais importante campo — a razão de ser do datagrama! Em muitas circunstâncias, o campo de dados do datagrama IP contém o segmento da camada de transporte (TCP ou UDP) a ser entregue ao destino. Contudo, o campo de dados pode carregar outros tipos de dados, como mensagens ICMP (discutidas na Seção 4.4.3).